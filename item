local ItemESP = {}

local espEnabled = false
local maxDistance = 1000
local espObjects = {}

function ItemESP.Init()
    game:GetService("RunService").RenderStepped:Connect(function()
        if espEnabled then
            ItemESP.Update()
        end
    end)
    return ItemESP
end

function ItemESP.CreateESP(item)
    if not item:IsA("Model") and not item:IsA("BasePart") then return end
    
    local esp = Instance.new("BillboardGui")
    esp.Name = "ItemESP"
    esp.AlwaysOnTop = true
    esp.Size = UDim2.new(0, 200, 0, 70) -- Increased height for extra info
    esp.StudsOffset = Vector3.new(0, 2, 0)
    
    if item:IsA("Model") and item:FindFirstChild("PrimaryPart") then
        esp.Adornee = item.PrimaryPart
    else
        local part = item:IsA("BasePart") and item or item:FindFirstChildWhichIsA("BasePart")
        if part then
            esp.Adornee = part
        else
            esp:Destroy()
            return
        end
    end
    
    -- Main name label
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "NameLabel"
    nameLabel.BackgroundTransparency = 1
    nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
    nameLabel.Position = UDim2.new(0, 0, 0, 0)
    nameLabel.Text = "ðŸ’Ž " .. item.Name
    nameLabel.TextColor3 = Color3.fromRGB(0, 255, 255)
    nameLabel.TextStrokeTransparency = 0
    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.TextSize = 18
    nameLabel.Parent = esp
    
    -- Info label
    local infoLabel = Instance.new("TextLabel")
    infoLabel.Name = "InfoLabel"
    infoLabel.BackgroundTransparency = 1
    infoLabel.Size = UDim2.new(1, 0, 0.5, 0)
    infoLabel.Position = UDim2.new(0, 0, 0.5, 0)
    infoLabel.Text = ""
    infoLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    infoLabel.TextStrokeTransparency = 0
    infoLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    infoLabel.Font = Enum.Font.SourceSans
    infoLabel.TextSize = 14
    infoLabel.Parent = esp
    
    -- Get info from ObjectInfo if it exists
    if item:FindFirstChild("ObjectInfo") and item.ObjectInfo:FindFirstChild("TextLabel") then
        infoLabel.Text = item.ObjectInfo.TextLabel.Text
    end
    
    esp.Parent = game.CoreGui
    
    table.insert(espObjects, {
        esp = esp,
        item = item
    })
    
    return esp
end

function ItemESP.Update()
    local player = game.Players.LocalPlayer
    local character = player.Character
    local humanoidRootPart = character and character:FindFirstChild("HumanoidRootPart")
    
    if not espEnabled or not humanoidRootPart then
        for _, obj in pairs(espObjects) do
            if obj.esp then
                obj.esp:Destroy()
            end
        end
        espObjects = {}
        return
    end
    
    for i = #espObjects, 1, -1 do
        local obj = espObjects[i]
        if not obj.esp or not obj.esp.Parent or not obj.item or not obj.item.Parent then
            if obj.esp and obj.esp.Parent then
                obj.esp:Destroy()
            end
            table.remove(espObjects, i)
        else
            local itemPosition
            if obj.item:IsA("Model") and obj.item:FindFirstChild("PrimaryPart") then
                itemPosition = obj.item.PrimaryPart.Position
            else
                local part = obj.item:IsA("BasePart") and obj.item or obj.item:FindFirstChildWhichIsA("BasePart")
                if part then
                    itemPosition = part.Position
                else
                    if obj.esp then obj.esp:Destroy() end
                    table.remove(espObjects, i)
                    continue
                end
            end
            
            local distance = (humanoidRootPart.Position - itemPosition).Magnitude
            obj.esp.Enabled = distance <= maxDistance
            
            local nameLabel = obj.esp:FindFirstChild("NameLabel")
            if nameLabel then
                nameLabel.Text = "ðŸ’Ž " .. obj.item.Name .. " [" .. math.floor(distance) .. "m]"
            end
            
            -- Update info label if ObjectInfo changes
            local infoLabel = obj.esp:FindFirstChild("InfoLabel")
            if infoLabel and obj.item:FindFirstChild("ObjectInfo") and obj.item.ObjectInfo:FindFirstChild("TextLabel") then
                infoLabel.Text = obj.item.ObjectInfo.TextLabel.Text
            end
        end
    end
    
    if workspace:FindFirstChild("RuntimeItems") then
        for _, item in pairs(workspace.RuntimeItems:GetChildren()) do
            local found = false
            for _, obj in pairs(espObjects) do
                if obj.item == item then
                    found = true
                    break
                end
            end
            
            if not found then
                ItemESP.CreateESP(item)
            end
        end
    end
end

function ItemESP.Toggle(enabled)
    espEnabled = enabled
    if enabled then
        ItemESP.Update()
    else
        for _, obj in pairs(espObjects) do
            if obj.esp then
                obj.esp:Destroy()
            end
        end
        espObjects = {}
    end
end

function ItemESP.SetMaxDistance(distance)
    maxDistance = distance
end

function ItemESP.IsEnabled()
    return espEnabled
end

return ItemESP.Init()
